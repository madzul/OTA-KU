image: node:20-alpine

stages:
  - build
  - test
  - deploy

variables:
  GIT_STRATEGY: "clone" # Reverting to clone to avoid lock issues
  CYPRESS_CACHE_FOLDER: "$CI_PROJECT_DIR/.cypress-cache"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

# Global cache definition
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm/
    - .cypress-cache/

# Git lock cleanup helper
.git-cleanup: &git-cleanup
  - |
    echo "Cleaning up potential Git locks..."
    if [ -f .git/shallow.lock ]; then
      rm -f .git/shallow.lock
    fi
    if [ -f .git/index.lock ]; then
      rm -f .git/index.lock
    fi

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

include:
  - local: "backend/.gitlab-ci.yml"
    rules:
      - changes:
          - "backend/**/*"
          - ".gitlab-ci.yml"
  - local: "frontend/.gitlab-ci.yml"
    rules:
      - changes:
          - "frontend/**/*"
          - ".gitlab-ci.yml"
