.backend-base:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-backend
    paths:
      - backend/node_modules/
    policy: pull-push
  before_script:
    - |
      echo "Cleaning up potential Git locks..."
      if [ -f .git/shallow.lock ]; then
        rm -f .git/shallow.lock
      fi
      if [ -f .git/index.lock ]; then
        rm -f .git/index.lock
      fi

backend-build-job:
  extends: .backend-base
  stage: build
  script:
    - echo "Building backend with Hono..."
    - cd backend
    - cp "$BACKEND_ENV_FILE" .env
    # CI/CD optimization: only install if node_modules doesn't exist or package.json has changed
    - |
      if [ ! -d "node_modules" ] || [ "$(stat -c %Y package.json)" -gt "$(stat -c %Y node_modules 2>/dev/null || echo 0)" ]; then
        echo "Installing dependencies..."
        npm ci
      else
        echo "Using cached node_modules"
      fi
    - npm run build
  artifacts:
    expire_in: 1 day
    paths:
      - backend/.env
      - backend/dist/

backend-test-job:
  extends: .backend-base
  stage: test
  needs:
    - backend-build-job
  image: node:20-bookworm
  services:
    - name: postgres:16
      alias: db
  before_script:
    - apt-get update && apt-get install -y postgresql-client
  script:
    - echo "Testing backend..."
    - cd backend
    - cp "$BACKEND_ENV_FILE" .env
    # Ensure required environment variables are available
    - |
      if ! grep -q "DATABASE_URL" .env || ! grep -q "JWT_SECRET" .env; then
        echo "ERROR: Required environment variables missing in .env"
        exit 1
      fi
    - export $(grep -v '^#' .env | xargs)
    - echo "Waiting for PostgreSQL to be ready..."
    - printenv
    - until pg_isready -p 5432 -U "$POSTGRES_USER" -d "$POSTGRES_DB"; do sleep 2; done
    - echo "Database is ready!"
    - npm ci --prefer-offline
    - npm run drizzle-kit:migrate
    - npm run test
  cache:
    policy: pull

backend-deploy-job:
  extends: .backend-base
  stage: deploy
  needs:
    - backend-test-job
  script:
    - echo "Deploying backend..."
    # Add backend deployment commands here
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  cache:
    policy: pull
